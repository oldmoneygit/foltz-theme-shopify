{%- assign rendered_blocks = "" | split: "" -%}

<form method="post" action="/cart/add" id="{{ product_form_id }}" accept-charset="UTF-8" enctype="multipart/form-data">
  <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" data-product-variant-id />

  <div class="product-info">
    {%- for block in section.blocks -%}
      {%- unless rendered_blocks contains block.type -%}
        {%- assign rendered_blocks = rendered_blocks | push: block.type -%}

        {%- case block.type -%}

          {%- when 'vendor' -%}
            {%- if product.vendor != blank -%}
              <div class="product-info__vendor" {{ block.shopify_attributes }}>
                <span style="color: var(--color-brand-yellow); font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                  {{ product.vendor }}
                </span>
              </div>
            {%- endif -%}

          {%- when 'title' -%}
            <h1 class="product-info__title" {{ block.shopify_attributes }} style="font-size: 2.5rem; font-weight: 700; color: #FFFFFF; line-height: 1.2; margin: 0;">
              {{ product.title }}
            </h1>

          {%- when 'price' -%}
            <div class="product-info__price" {{ block.shopify_attributes }}>
              {%- assign current_variant = product.selected_or_first_available_variant -%}
              {%- assign compare_at_price = current_variant.compare_at_price -%}
              {%- assign price = current_variant.price -%}
              {%- assign on_sale = false -%}
              {%- if compare_at_price and compare_at_price > price -%}
                {%- assign on_sale = true -%}
              {%- endif -%}

              <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <div style="font-size: 2rem; font-weight: 700; {% if on_sale %}color: var(--color-brand-yellow);{% else %}color: #FFFFFF;{% endif %}">
                  {{ price | money }}
                </div>

                {%- if on_sale -%}
                  <div style="font-size: 1.25rem; font-weight: 500; color: rgba(255,255,255,0.5); text-decoration: line-through;">
                    {{ compare_at_price | money }}
                  </div>

                  {%- assign savings_amount = compare_at_price | minus: price -%}
                  {%- assign savings_percent = savings_amount | times: 100.0 | divided_by: compare_at_price | round -%}

                  <div style="padding: 6px 12px; background: var(--color-brand-yellow); color: #000000; font-size: 0.75rem; font-weight: 700; border-radius: 16px; text-transform: uppercase; letter-spacing: 0.5px;">
                    -{{ savings_percent }}%
                  </div>
                {%- endif -%}
              </div>
            </div>

          {%- when 'variant_picker' -%}
            {%- unless product.has_only_default_variant -%}
              <div class="product-info__variants" {{ block.shopify_attributes }}>
                {%- for option in product.options_with_values limit: 3 -%}
                  <div class="product-option" style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 12px; font-size: 0.875rem; font-weight: 600; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 0.5px;">
                      {{ option.name }}
                    </label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                      {%- for value in option.values limit: 10 -%}
                        <input
                          type="radio"
                          id="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                          name="options[{{ option.name }}]"
                          value="{{ value | escape }}"
                          form="{{ product_form_id }}"
                          {% if option.selected_value == value %}checked{% endif %}
                          style="display: none;"
                        >
                        <label
                          for="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                          style="min-width: 60px; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; color: #FFFFFF; font-size: 0.875rem; font-weight: 500; cursor: pointer; text-align: center; transition: all 0.3s ease;"
                        >
                          {{ value }}
                        </label>
                      {%- endfor -%}
                    </div>
                  </div>
                {%- endfor -%}
              </div>
            {%- endunless -%}

          {%- when 'quantity' -%}
            <div class="product-info__quantity" {{ block.shopify_attributes }} style="margin-bottom: 24px;">
              <label style="display: block; margin-bottom: 12px; font-size: 0.875rem; font-weight: 600; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 0.5px;">
                Quantidade
              </label>
              <div style="display: flex; align-items: center; border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; width: fit-content;">
                <button type="button" onclick="this.nextElementSibling.stepDown(); this.nextElementSibling.dispatchEvent(new Event('change'));" style="width: 40px; height: 40px; background: rgba(255,255,255,0.05); border: none; color: #FFFFFF; cursor: pointer; font-size: 1.25rem;">-</button>
                <input
                  type="number"
                  name="quantity"
                  value="1"
                  min="1"
                  style="width: 60px; height: 40px; text-align: center; background: transparent; border: none; color: #FFFFFF; font-size: 1rem; font-weight: 600;"
                >
                <button type="button" onclick="this.previousElementSibling.stepUp(); this.previousElementSibling.dispatchEvent(new Event('change'));" style="width: 40px; height: 40px; background: rgba(255,255,255,0.05); border: none; color: #FFFFFF; cursor: pointer; font-size: 1.25rem;">+</button>
              </div>
            </div>

          {%- when 'buy_buttons' -%}
            <div class="product-info__buy-buttons" {{ block.shopify_attributes }}>
              <button
                type="submit"
                name="add"
                style="width: 100%; padding: 16px 32px; background: var(--color-brand-yellow); color: #000000; font-size: 1rem; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease;"
                {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}
              >
                {%- if product.selected_or_first_available_variant.available -%}
                  Adicionar ao Carrinho
                {%- else -%}
                  Esgotado
                {%- endif -%}
              </button>
            </div>

          {%- when 'description' -%}
            {%- if product.description != blank -%}
              <div class="product-info__description" {{ block.shopify_attributes }} style="margin-top: 32px; padding-top: 32px; border-top: 1px solid rgba(255,255,255,0.1);">
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #FFFFFF; margin-bottom: 16px;">Descrição</h3>
                <div style="font-size: 1rem; color: rgba(255,255,255,0.7); line-height: 1.8;">
                  {{ product.description }}
                </div>
              </div>
            {%- endif -%}

          {%- when 'share' -%}
            <div class="product-info__share" {{ block.shopify_attributes }} style="margin-top: 24px; display: flex; gap: 12px; align-items: center;">
              <span style="font-size: 0.875rem; color: rgba(255,255,255,0.7);">Compartilhar:</span>
              <a href="https://www.facebook.com/sharer/sharer.php?u={{ shop.url }}{{ product.url }}" target="_blank" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; color: #FFFFFF; transition: all 0.3s ease;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
              </a>
              <a href="https://twitter.com/intent/tweet?url={{ shop.url }}{{ product.url }}&text={{ product.title }}" target="_blank" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; color: #FFFFFF; transition: all 0.3s ease;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
              </a>
            </div>

        {%- endcase -%}
      {%- endunless -%}
    {%- endfor -%}
  </div>
</form>

<script>
(function() {
  const form = document.querySelector('#{{ product_form_id }}');
  if (!form) return;

  const variantIdInput = form.querySelector('[data-product-variant-id]');
  const variants = {{ product.variants | json }};

  // Listen for option changes
  form.addEventListener('change', function(e) {
    if (e.target.name && e.target.name.startsWith('options[')) {
      updateVariant();
    }
  });

  function updateVariant() {
    const options = Array.from(form.querySelectorAll('input[name^="options["]:checked')).map(input => input.value);

    const variant = variants.find(v => {
      return options.every((option, index) => {
        return v['option' + (index + 1)] === option;
      });
    });

    if (variant) {
      variantIdInput.value = variant.id;
      updateButton(variant);
    }
  }

  function updateButton(variant) {
    const button = form.querySelector('button[type="submit"]');
    if (button) {
      if (variant.available) {
        button.disabled = false;
        button.textContent = 'Adicionar ao Carrinho';
      } else {
        button.disabled = true;
        button.textContent = 'Esgotado';
      }
    }
  }

  // Style selected variant options
  const labels = form.querySelectorAll('input[type="radio"] + label');
  labels.forEach(label => {
    const input = label.previousElementSibling;
    if (input.checked) {
      label.style.borderColor = 'var(--color-brand-yellow)';
      label.style.background = 'var(--color-brand-yellow)';
      label.style.color = '#000000';
    }

    label.addEventListener('click', function() {
      labels.forEach(l => {
        l.style.borderColor = 'rgba(255,255,255,0.1)';
        l.style.background = 'rgba(255,255,255,0.05)';
        l.style.color = '#FFFFFF';
      });
      this.style.borderColor = 'var(--color-brand-yellow)';
      this.style.background = 'var(--color-brand-yellow)';
      this.style.color = '#000000';
    });
  });
})();
</script>

<style>
  .product-info {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .product-info__buy-buttons button:hover:not(:disabled) {
    opacity: 0.9;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(218, 241, 13, 0.3);
  }

  .product-info__buy-buttons button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .product-info__share a:hover {
    background: rgba(218, 241, 13, 0.1);
    border-color: var(--color-brand-yellow);
    color: var(--color-brand-yellow);
  }
</style>
